<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
(async () => {

  await liff.init({ liffId: "2008602232-oZ1VyrwX" });

  if (!liff.isLoggedIn()) return liff.login();

  // 1. 先把 LIFF 視窗關閉（這是關鍵）
  setTimeout(() => liff.closeWindow(), 50);

  const profile = await liff.getProfile();

  const urlParams = new URLSearchParams(location.search);
  const action = urlParams.get("action");

  // 2. 呼叫 n8n webhook
  const res = await fetch("https://booblublublu.app.n8n.cloud/webhook/liff-entry", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      action,
      userId: profile.userId,
      displayName: profile.displayName,
      timestamp: new Date().toISOString()
    })
  });

  const result = await res.json();

  // 3. 直接把回覆塞回 LINE 聊天室
  await liff.sendMessages([
    { type: "text", text: result.message }
  ]);

})();
</script>
